package com.hxy.isw.service.impl;

import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.alibaba.cloudapi.sdk.core.model.ApiResponse;
import com.google.gson.Gson;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.hxy.isw.entity.CapitalDetail;
import com.hxy.isw.entity.Documentary;
import com.hxy.isw.entity.ExamplePlan;
import com.hxy.isw.entity.Follow;
import com.hxy.isw.entity.ForeignExchange;
import com.hxy.isw.entity.GoldsDetail;
import com.hxy.isw.entity.PanicBuying;
import com.hxy.isw.entity.Shares;
import com.hxy.isw.entity.SharesCollect;
import com.hxy.isw.entity.SharesWareHouse;
import com.hxy.isw.entity.Subscription;
import com.hxy.isw.entity.UserInfo;
import com.hxy.isw.entity.UserProfit;
import com.hxy.isw.entity.UserProfitStatistic;
import com.hxy.isw.service.AppServiceExample;
import com.hxy.isw.util.ConstantUtil;
import com.hxy.isw.util.DatabaseHelper;
import com.hxy.isw.util.JsonUtil;
import com.hxy.isw.util.NowApiUtil;
import com.hxy.isw.util.SyncDemo_股票行情;
import com.hxy.isw.util.Sys;

/**
* @author lcc
* @date 2017年7月20日 下午3:13:41
* @describe
*/

@Repository
public class AppServiceExampleImpl implements AppServiceExample {

	@Autowired
	DatabaseHelper databaseHelper;

	@Override
	public String quotation4hs(String userid,String type, int start, int limit) throws Exception {
		// TODO Auto-generated method stub
		if(type==null||type.length()==0)throw new Exception("参数type不能为空");
		
		int int_type = Integer.parseInt(type);
		
		String upanddown = int_type==1?"涨":"跌";
		
		int count = countquotation4hs(userid,upanddown);
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		if(count>0){
			StringBuffer query = new StringBuffer("select s from Shares s where s.type = 0 and s.state = 0 and s.upanddown = '").append(upanddown).append("'")
					.append(" order by s.diffmoney desc");
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(), start, limit);
			
			for (Object object : lst) {
				Shares s = (Shares)object;
				
				Map<String,Object> map = new HashMap<String,Object>();
				
				map.put("shareid", s.getId());
				map.put("sharename", s.getSharesname());
				map.put("code", s.getCode());
				map.put("market", s.getMarket());
				map.put("price", s.getPrice());
				map.put("diffmoney", s.getDiffmoney());
				map.put("diffrate", s.getDiffrate());
				map.put("lastupdate", new Date().toString());
				map.put("type",s.getType());//0沪深 1美股 2外汇
				
				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.add("rows", arr);
		
		return obj.toString();
	}

	public int countquotation4hs(String userid,String upanddown){
		StringBuffer count = new StringBuffer("select count(s.id) from Shares s where s.type = 0 and s.state = 0 and s.upanddown = '").append(upanddown).append("'");
		List lst = databaseHelper.getResultListByHql(count.toString());
		return Integer.parseInt(lst.get(0).toString());
	}
	
	@Override
	public String index4shares(String userid,String type) throws Exception {
		// TODO Auto-generated method stub
		if(type==null||type.length()==0)throw new Exception("参数type不能为空");
		
		String json = "";
		
		if("hs".equals(type)) json = new Gson().toJson(ConstantUtil.lm_index_hs);
		else if("us".equals(type))json = new Gson().toJson(ConstantUtil.lm_index_us);
		else if("wh".equals(type))json = new Gson().toJson(ConstantUtil.lm_index_wh);
		else json = new Gson().toJson(ConstantUtil.lm_index_hs);
		
		
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",arr.size());
		obj.add("rows", arr);
		return obj.toString();
	}

	@Override
	public String queryshareslist(String userid, String condition, int start, int limit) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("用户id不能为空");
		
		int count = countshares(userid,condition);
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		if(count>0){
			StringBuffer query = new StringBuffer("select s from Shares s where s.state = 0 ");
			
			if(condition!=null&&condition.length()>0){
				query = query.append("and (s.sharesname like '%").append(condition).append("%'")
					.append(" or s.code like '%").append(condition).append("%')");
			}
			
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(), start, limit);
			
			for (Object object : lst) {
				Shares s = (Shares)object;
				
				Map<String,Object> map = new HashMap<String,Object>();
				
				map.put("shareid", s.getId());
				map.put("sharename", s.getSharesname());
				map.put("code", s.getCode());
				map.put("market", s.getMarket());
				map.put("price", s.getPrice());
				map.put("diffmoney", s.getDiffmoney());
				map.put("diffrate", s.getDiffrate());
				map.put("lastupdate", new Date().toString());
				map.put("type",s.getType());//0沪深 1美股 2外汇
				//检查此股票是否被此用户添加为自选股（收藏）
				query = new StringBuffer("select sc from SharesCollect sc where sc.foruserinfoid = ").append(Long.parseLong(userid)).append(" and sc.code = '")
						.append(s.getCode()).append("'");
				
				List<Object> clst = databaseHelper.getResultListByHql(query.toString());
				
				if(clst.size()==0)map.put("collected", 0);
				else{
					SharesCollect sc = (SharesCollect)clst.get(0);
					
					if(sc.getState()==0){
						map.put("collected", 1);
						map.put("fcollectid", sc.getId());
					}else{
						map.put("collected", 0);
					}
				}
				
				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.add("rows", arr);
		
		return obj.toString();
	}

	
	public int countshares(String userid,String condition){
		StringBuffer count = new StringBuffer("select count(s.id) from Shares s where s.state = 0 and (s.sharesname like '%").append(condition).append("%'")
				.append(" or s.code like '%").append(condition).append("%')");
		
		if(condition!=null&&condition.length()>0){
			count = count.append("and (s.sharesname like '%").append(condition).append("%'")
				.append(" or s.code like '%").append(condition).append("%')");
		}
		
		List lst = databaseHelper.getResultListByHql(count.toString());
		return Integer.parseInt(lst.get(0).toString());
	}

	@Override
	public String sharesdetail(String userid, String shareid, String code, String type) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("userid不能为空");
		
		if(shareid==null||shareid.length()==0)throw new Exception("shareid不能为空");
		
		Shares s = (Shares)databaseHelper.getObjectById(Shares.class, Long.parseLong(shareid));
		
		String quotation = s.getQuotation();
		
		JsonObject json = (JsonObject) new JsonParser().parse(quotation);
		
		//检查此用户是否对此股票有持仓
		StringBuffer check = new StringBuffer("select swh from SharesWareHouse swh where swh.state = 0 and swh.couldusenums > 0")
				.append(" and swh.fuserinfoid = ").append(Long.parseLong(userid)).append(" and swh.fsharesid = ").append(Long.parseLong(shareid))
				.append(" and swh.isplan = 0");
		
		List<Object> lst = databaseHelper.getResultListByHql(check.toString());
		
		if(lst.size()==0)json.addProperty("hasthisshare", 0);
		else json.addProperty("hasthisshare", 1);
		
		return json.toString();
	}

	@Override
	public String sharesKline(String userid, String shareid, String code, String type) throws Exception {
		// TODO Auto-generated method stub
		
		
		if(type==null||type.length()==0)throw new Exception("参数type不能为空");
		
		if("mh".equals(type)){
			//分时线
			
			
			
		}
		
		return null;
	}

	@Override
	public String queryexamplelist(String userid, String condition, int start, int limit) throws Exception {
		// TODO Auto-generated method stub
		int count = countshares(userid,condition);
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		if(count>0){
			StringBuffer query = new StringBuffer("select u from UserInfo u where u.state = 0 and u.isexample = 1 ");
			
			if(condition!=null&&condition.length()>0){
				query = query.append(" and  u.name like '%").append(condition).append("%'")
						.append(" or u.nickname like '%").append(condition).append("%')");
			}
			
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(),start,limit);
			
			for (Object object : lst) {
				UserInfo u = (UserInfo)object;
				
				Map<String, Object> map = new HashMap<String, Object>();
				
				map.put("name", u.getName());
				map.put("nickname", u.getNickname());
				map.put("headimg", u.getHeadimg()==null?"":u.getHeadimg());
				map.put("exampleid", u.getId());

				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.add("rows", arr);
		
		return obj.toString();
	}
	
	
	public int countexample(String userid,String condition){
		StringBuffer count = new StringBuffer("select count(u.id) from UserInfo u where u.state = 0 and u.isexample = 1 ");
		
		if(condition!=null&&condition.length()>0){
			count = count.append(" and  u.name like '%").append(condition).append("%'")
					.append(" or u.nickname like '%").append(condition).append("%')");
		}
		
		List lst = databaseHelper.getResultListByHql(count.toString());
		return Integer.parseInt(lst.get(0).toString());
	}

	@Override
	public String profitrankinglist(String userid, String type, int start, int limit) throws Exception {
		// TODO Auto-generated method stub
		if(type==null||type.length()==0)throw new Exception("参数type不能为空");
		if(userid==null||userid.length()==0)throw new Exception("userid不能为空");
		
		int int_type = Integer.parseInt(type);
		
		int count = countprofitranking(userid,int_type);
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		
		StringBuffer check = null;
		if(count>0){
			StringBuffer query = new StringBuffer("select u,ups from UserInfo u,UserProfitStatistic ups where u.state = 0 and u.isexample = 1 and ups.fuserinfoid = u.id ");
			
				
				
				if(int_type==-1)query = query.append(" order by ups.totalrate desc");
				else if(int_type==0)query = query.append(" order by ups.rateofhs desc");
				else if(int_type==1)query = query.append(" order by ups.rateofus desc");
				else if(int_type==2)query = query.append(" order by ups.rateofwh desc");
			
			List<Object[]> lst = databaseHelper.getResultListByHql(query.toString(),start,limit);
			
			for (Object[] objects : lst) {
				UserInfo u = (UserInfo)objects[0];
				UserProfitStatistic ups = (UserProfitStatistic)objects[1];
				
				Map<String, Object> map = new HashMap<String, Object>();
				
				map.put("name", u.getName());
				map.put("nickname", u.getNickname());
				map.put("headimg", u.getHeadimg()==null?"":u.getHeadimg());
				map.put("exampleid", u.getId());
				
				if(int_type==-1)map.put("profitrate", ups.getTotalrate());
				else if(int_type==0)map.put("profitrate", ups.getRateofhs());
				else if(int_type==1)map.put("profitrate", ups.getRateofus());
				else if(int_type==2)map.put("profitrate", ups.getRateofwh());
				
				map.put("fans", ups.getFans());
				
				//检查当前用户是否关注此人
				check = new StringBuffer("select f from Follow f where f.state = 0 and f.fuserinfoid = ").append(Long.parseLong(userid)).append(" and f.ffollowedid =").append(u.getId());
				List<Object> clst = databaseHelper.getResultListByHql(check.toString());
				if(clst.size()==0){
					map.put("followed", 0);
				}else{
					Follow f = (Follow)clst.get(0);
					map.put("followed", 1);
					map.put("followid", f.getId());
				}
				
				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.add("rows", arr);
		
		return obj.toString();
	}
	
	
	public int countprofitranking(String userid,int int_type){
		StringBuffer count = new StringBuffer("select count(ups.id) from UserInfo u,UserProfitStatistic ups where u.state = 0 and u.isexample = 1 and ups.fuserinfoid = u.id ");
		
		List lst = databaseHelper.getResultListByHql(count.toString());
		return Integer.parseInt(lst.get(0).toString());
	}

	@Override
	public String popularityrankinglist(String userid, int start, int limit) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("userid不能为空");
		
		
		int count = countprofitranking(userid,-1);
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		
		StringBuffer check = null;
		if(count>0){
			StringBuffer query = new StringBuffer("select u,ups from UserInfo u,UserProfitStatistic ups where u.state = 0 and u.isexample = 1 and ups.fuserinfoid = u.id ")
					.append(" order by ups.fans desc");
			
			
			
			List<Object[]> lst = databaseHelper.getResultListByHql(query.toString(),start,limit);
			
			for (Object[] objects : lst) {
				UserInfo u = (UserInfo)objects[0];
				UserProfitStatistic ups = (UserProfitStatistic)objects[1];
				
				Map<String, Object> map = new HashMap<String, Object>();
				
				map.put("name", u.getName());
				map.put("nickname", u.getNickname());
				map.put("headimg", u.getHeadimg()==null?"":u.getHeadimg());
				map.put("exampleid", u.getId());
		
				
				map.put("fans", ups.getFans());
				map.put("rewordnums", ups.getRewordnums());
				
				//检查当前用户是否关注此人
				check = new StringBuffer("select f from Follow f where f.state = 0 and f.fuserinfoid = ").append(Long.parseLong(userid)).append(" and f.ffollowedid =").append(u.getId());
				List<Object> clst = databaseHelper.getResultListByHql(check.toString());
				if(clst.size()==0){
					map.put("followed", 0);
				}else{
					Follow f = (Follow)clst.get(0);
					map.put("followed", 1);
					map.put("followid", f.getId());
				}
				
				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.add("rows", arr);
		
		return obj.toString();
	}

	@Override
	public String planrankinglist(String userid, String type, int start, int limit) throws Exception {
		// TODO Auto-generated method stub
		if(type==null||type.length()==0)throw new Exception("参数type不能为空");
		if(userid==null||userid.length()==0)throw new Exception("userid不能为空");
		
		int int_type = Integer.parseInt(type);
		
		int count = countprofitranking(userid,int_type);
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		
		StringBuffer check = null;
		if(count>0){
			StringBuffer query = new StringBuffer("select u,ups from UserInfo u,UserProfitStatistic ups where u.state = 0 and u.isexample = 1 and ups.fuserinfoid = u.id ");
			
				
				
				if(int_type==-1)query = query.append(" order by ups.totalplansuccess desc,ups.totalplanfrofit desc");
				else if(int_type==0)query = query.append(" order by ups.hsplansuccess desc,ups.hsplanfrofit desc");
				else if(int_type==1)query = query.append(" order by ups.usplansuccess desc,ups.usplanfrofit desc");
				else if(int_type==2)query = query.append(" order by ups.whplansuccess desc,ups.whplanfrofit desc");
			
			List<Object[]> lst = databaseHelper.getResultListByHql(query.toString(),start,limit);
			
			for (Object[] objects : lst) {
				UserInfo u = (UserInfo)objects[0];
				UserProfitStatistic ups = (UserProfitStatistic)objects[1];
				
				Map<String, Object> map = new HashMap<String, Object>();
				
				map.put("name", u.getName());
				map.put("nickname", u.getNickname());
				map.put("headimg", u.getHeadimg()==null?"":u.getHeadimg());
				map.put("exampleid", u.getId());
				
				if(int_type==-1){
					map.put("planfrofit", ups.getTotalplanfrofit());
					map.put("successrate", ups.getTotalplansuccess());
				}else if(int_type==0){
					map.put("planfrofit", ups.getHsplanfrofit());
					map.put("successrate", ups.getHsplansuccess());
				}else if(int_type==1){
					map.put("planfrofit", ups.getUsplanfrofit());
					map.put("successrate", ups.getUsplansuccess());
				}else if(int_type==2){
					map.put("planfrofit", ups.getWhplanfrofit());
					map.put("successrate", ups.getWhplansuccess());
				}
				
				
				//检查当前用户是否关注此人
				check = new StringBuffer("select f from Follow f where f.state = 0 and f.fuserinfoid = ").append(Long.parseLong(userid)).append(" and f.ffollowedid =").append(u.getId());
				List<Object> clst = databaseHelper.getResultListByHql(check.toString());
				if(clst.size()==0){
					map.put("followed", 0);
				}else{
					Follow f = (Follow)clst.get(0);
					map.put("followed", 1);
					map.put("followid", f.getId());
				}
				
				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.add("rows", arr);
		
		return obj.toString();
	}

	@Override
	public String exampledetail(String userid, String exampleid) throws Exception {
		// TODO Auto-generated method stub
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		Date now = new Date();
		int year = Integer.parseInt(sdf.format(now).split("-")[0]);
		int month = Integer.parseInt(sdf.format(now).split("-")[1]);
		
		if(userid==null||userid.length()==0)throw new Exception("参数userid不能为空");
		if(exampleid==null||exampleid.length()==0)throw new Exception("参数exampleid不能为空");
		
		UserInfo example = (UserInfo)databaseHelper.getObjectById(UserInfo.class, Long.parseLong(exampleid));
		
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("name",example.getName());
		map.put("nickname",example.getNickname());
		map.put("headimg",example.getHeadimg());
		
		//查看牛人的粉丝数
		StringBuffer query = new StringBuffer("select count(f.id) from Follow f where f.state = 0 and f.ffollowedid = ").append(example.getId());
		List lst = databaseHelper.getResultListByHql(query.toString());
		int fans = Integer.parseInt(lst.get(0).toString());
		map.put("fans",fans);
		
		//查看牛人的关注数
		query = new StringBuffer("select count(f.id) from Follow f where f.state = 0 and f.fuserinfoid = ").append(example.getId());
		lst = databaseHelper.getResultListByHql(query.toString());
		int follows = Integer.parseInt(lst.get(0).toString());
		map.put("follows",follows);
		
		//累计收益--持仓
		query = new StringBuffer("select sum(userp.diffprofitoflasttime) 'a' from userprofit userp where userp.tags = 1 and userp.fuserinfoid = ").append(example.getId());
		lst = databaseHelper.getResultListBySql(query.toString());
		
		Double profit0 = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		//累计收益--卖出
		query = new StringBuffer("select sum(userp.profit) 'a' from userprofit userp where userp.tags = 0 and userp.fuserinfoid = ").append(example.getId());
		lst = databaseHelper.getResultListBySql(query.toString());
		
		Double profit1 = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		map.put("totalprofit",profit0+profit1);
		
		
		//年收益--持仓
		query = new StringBuffer("select sum(userp.diffprofitoflasttime) 'a' from userprofit userp where year(userp.time)=").append(year).append(" and userp.tags = 1 and userp.fuserinfoid = ").append(example.getId());
		lst = databaseHelper.getResultListBySql(query.toString());
		
		Double year_profit0 = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		//年收益--卖出
		query = new StringBuffer("select sum(userp.profit) 'a' from userprofit userp where year(userp.time)=").append(year).append(" and userp.tags = 0 and userp.fuserinfoid = ").append(example.getId());
		lst = databaseHelper.getResultListBySql(query.toString());
		
		Double year_profit1 = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		map.put("yearprofit",year_profit0+year_profit1);
		
		
		//月收益--持仓
		query = new StringBuffer("select sum(userp.diffprofitoflasttime) 'a' from userprofit userp where year(userp.time)=").append(year).append(" and month(userp.time) = ").append(month).append(" and userp.tags = 1 and userp.fuserinfoid = ").append(example.getId());
		lst = databaseHelper.getResultListBySql(query.toString());
		
		Double month_profit0 = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		//月收益--卖出
		query = new StringBuffer("select sum(userp.profit) 'a' from userprofit userp where year(userp.time)=").append(year).append(" and month(userp.time) = ").append(month).append(" and userp.tags = 0 and userp.fuserinfoid = ").append(example.getId());
		lst = databaseHelper.getResultListBySql(query.toString());
		
		Double month_profit1 = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		map.put("monthprofit",month_profit0+month_profit1);
		
		
		//检查用户是否关注此牛人
		StringBuffer check = new StringBuffer("select f from Follow f where f.state = 0 and f.fuserinfoid = ").append(Long.parseLong(userid)).append(" and f.ffollowedid =").append(example.getId());
		List<Object> clst = databaseHelper.getResultListByHql(check.toString());
		if(clst.size()==0){
			map.put("followed", 0);
		}else{
			Follow f = (Follow)clst.get(0);
			map.put("followed", 1);
			map.put("followid", f.getId());
		}
		
		
		//检查用户是否订阅此牛人
		check = new StringBuffer("select s from Subscription s where s.state = 0 and s.fuserinfoid = ").append(Long.parseLong(userid)).append(" and s.fsubscribedid =").append(example.getId());
		clst = databaseHelper.getResultListByHql(check.toString());
		if(clst.size()==0){
			map.put("subscribed", 0);
		}else{
			Follow f = (Follow)clst.get(0);
			map.put("subscribed", 1);
			map.put("subscribid", f.getId());
		}
		
		
		//检查用户是否跟随此牛人
		check = new StringBuffer("select d from Documentary d where d.state = 0 and d.fuserinfoid = ").append(Long.parseLong(userid)).append(" and d.ffollowuserinfoid =").append(example.getId());
		clst = databaseHelper.getResultListByHql(check.toString());
		if(clst.size()==0){
			map.put("aftered", 0);
		}else{
			Follow f = (Follow)clst.get(0);
			map.put("aftered", 1);
			map.put("afterid", f.getId());
		}
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
	}


	@Override
	public String planlist(String userid, String exampleid, String self, String type, String tag, int start, int limit)
			throws Exception {
		// TODO Auto-generated method stub
		String result = "";
		
		if(exampleid!=null&&exampleid.length()>0){
			//查看牛人计划列表
			result = queryexampleplanlst(userid, exampleid, start, limit);
		}else{
			if(self!=null&&Integer.parseInt(self)==0){
				//查看我的计划列表
				result = queryselfplanlst(userid, tag, start, limit);
			}else{
				//查看所有计划列表
				result = queryallplanlst(userid, type, tag, start, limit);
			}
			
		}
		
		return result;
	}
	
	private Map<String, Object> staticofplan(Map<String, Object> map,ExamplePlan ep){
		map.put("startime", ep.getStarttime().toString());//计划开始时间
		map.put("endtime", ep.getEndtime().toString());//计划结束时间
		
		if(ep.getState()==0){//抢购中
			map.put("buyingendtime", ep.getStarttime().toString());
			//查看计划抢购人数
			StringBuffer check = new StringBuffer("select count(panicbuying.id) from PanicBuying panicbuying where panicbuying.fexampleplanid = ").append(ep.getId()).append(" and panicbuying.state = 0");
			List checklst = databaseHelper.getResultListByHql(check.toString());
			int buyingmembers =  Integer.parseInt(checklst.get(0).toString());
			map.put("buyingmembers", buyingmembers);
			
			map.put("distancetime", ConstantUtil.getDistanceTime(new Date(), ep.getStarttime()));//计划开始倒计时
			
		}else if(ep.getState()==1){//运行中
			int diffday = ConstantUtil.differentDays(ep.getStarttime(), new Date());
			map.put("runday", diffday<0?0:diffday);
			
			//查看计划中最新的持仓记录
			int type = ep.getType();
			if(type<2){
				//股票
				StringBuffer find = new StringBuffer("select swh from SharesWareHouse swh where swh.fexampleplanid = ").append(ep.getId()).append(" order by time desc");
				
				List<Object> findlst = databaseHelper.getResultListByHql(find.toString());
				
				if(findlst.size()==0){
					map.put("newplaytime","");
					map.put("warehouse","");
				}else{
					SharesWareHouse swh = (SharesWareHouse)findlst.get(0);
					int couldusenums = 0;
					for (Object object2 : findlst) {
						SharesWareHouse s = (SharesWareHouse)object2;
						couldusenums += s.getCouldusenums();
					}
					
					map.put("newplaytime",swh.getTime());
					
					double warehouse = ConstantUtil.intdevice2(swh.getCouldusenums(), couldusenums, true);//new BigDecimal((float)swh.getCouldusenums()/couldusenums*100).setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue();  
					
					map.put("warehouse",warehouse+"%");
				}
			}else{
				//外汇
				StringBuffer find = new StringBuffer("select fe from ForeignExchange fe where fe.fexampleplanid = ").append(ep.getId()).append(" order by time desc");
				
				List<Object> findlst = databaseHelper.getResultListByHql(find.toString());
				
				if(findlst.size()==0){
					map.put("newplaytime","");
					map.put("warehouse","");
				}else{
					ForeignExchange fe = (ForeignExchange)findlst.get(0);
					int couldusenums = 0;
					for (Object object2 : findlst) {
						ForeignExchange f = (ForeignExchange)object2;
						couldusenums += f.getCouldusenums();
					}
					
					map.put("newplaytime",fe.getTime());
					
					double warehouse = new BigDecimal((float)fe.getCouldusenums()/couldusenums*100).setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue();  
					
					map.put("warehouse",warehouse+"%");
				}
			}
			
			map.put("maxtime", diffday<0?0:diffday);//最长时限
			
			//TODO  大盘同期
			map.put("stockindex", "0%");//大盘同期
		}else if(ep.getState()==2){//已结束
			int diffday = ConstantUtil.differentDays(ep.getStarttime(), ep.getEndtime());
			map.put("runday", diffday<0?0:diffday);
			
			map.put("successed", ep.getSuccessed());
		}
		
		return map;
	}
	
	//查看牛人计划列表
	private String queryexampleplanlst(String userid, String exampleid,  int start, int limit){
		
		int count = countexampleplan(userid, exampleid);
		Map<String, Object> m = statisticexampleplan(userid, exampleid);
		
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		
		if(count>0){
			StringBuffer query = new StringBuffer("select ep from ExamplePlan ep where ep.fuserinfoid = ").append(Long.parseLong(exampleid));
			
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(), start, limit);
			
			for (Object object : lst) {
				ExamplePlan ep = (ExamplePlan)object;
				
				Map<String, Object> map = new HashMap<String, Object>();
				
				map.put("planid",ep.getId());
				map.put("planname",ep.getPlanname());
				map.put("plandesc",ep.getPlandesc());
				map.put("targetprofit",ep.getTargetprofit());
				map.put("stopline",ep.getStopline());
				map.put("actualprofit",ep.getActualprofit());
				
				
				map.put("state", ep.getState());
				map.put("type", ConstantUtil.type[ep.getType()]);
				map.put("planstate", ConstantUtil.planstate[ep.getState()]);//0抢购 1运行中 2已结束
				
				//检查当前用户对计划是否抢购或观摩
				StringBuffer checkb = new StringBuffer("select panicbuying from PanicBuying panicbuying where panicbuying.fexampleplanid = ").append(ep.getId())
						.append(" and panicbuying.fuserinfoid = ").append(Long.parseLong(userid));
				List<Object> checked = databaseHelper.getResultListByHql(checkb.toString());
				if(checked.size()==0){
					map.put("panicbuying", -1);
				}else{
					PanicBuying panicbuying = (PanicBuying)checked.get(0);
					map.put("panicbuying", panicbuying.getState());
				}
				
				map = staticofplan(map, ep);
				
				
				lstMap.add(map);
			}
			
		}
		
		//牛人信息
		UserInfo example = (UserInfo)databaseHelper.getObjectById(UserInfo.class, Long.parseLong(exampleid));
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.addProperty("name",example.getNickname()==null?example.getName():example.getNickname());
		obj.addProperty("headimg",example.getHeadimg());
		obj.addProperty("profitrate",m.get("profitrate").toString());
		obj.addProperty("successnums",m.get("successnums").toString());
		obj.add("rows", arr);
		
		return obj.toString();
		
	}
	
	public int countexampleplan(String userid, String exampleid){
		StringBuffer count = new StringBuffer("select count(ep.id) from ExamplePlan ep where ep.fuserinfoid = ").append(Long.parseLong(exampleid));
		
		List lst = databaseHelper.getResultListByHql(count.toString());
		return Integer.parseInt(lst.get(0).toString());
	}
	
	
	public Map<String, Object> statisticexampleplan(String userid, String exampleid){
		Map<String, Object> map = new HashMap<String, Object>();
		
		StringBuffer query = new StringBuffer("select ep from ExamplePlan ep where ep.fuserinfoid = ").append(Long.parseLong(exampleid));
		
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		
		Double total = 0d;
		int success = 0;
		for (Object object : lst) {
			ExamplePlan ep = (ExamplePlan)object;
			total += ep.getActualprofit();
			if(ep.getSuccessed()==1)success++;
		}
		
		double profitrate = new BigDecimal(total/lst.size()*100).setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue();  
		
		map.put("profitrate", profitrate);
		map.put("successnums", success);
		
		return map;
	}
	
	
	
	//查看个人计划列表
	private String queryselfplanlst(String userid, String tag,  int start, int limit){
		
		int count = countselfplan(userid, tag);
		Map<String, Object> m = statisticselfplan(userid, tag);
		
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		
		if(count>0){
			StringBuffer query = new StringBuffer("select ep from ExamplePlan ep where ep.fuserinfoid = ").append(Long.parseLong(userid)).append(" and ep.state = ").append(Integer.parseInt(tag));
			
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(), start, limit);
			
			for (Object object : lst) {
				ExamplePlan ep = (ExamplePlan)object;
				
				Map<String, Object> map = new HashMap<String, Object>();
				map.put("planid",ep.getId());
				map.put("planname",ep.getPlanname());
				map.put("plandesc",ep.getPlandesc());
				map.put("targetprofit",ep.getTargetprofit());
				map.put("stopline",ep.getStopline());
				map.put("actualprofit",ep.getActualprofit());
				
				map.put("state", ep.getState());
				map.put("type", ConstantUtil.type[ep.getType()]);
				map.put("planstate", ConstantUtil.planstate[ep.getState()]);//0抢购 1运行中 2已结束
				
				map = staticofplan(map, ep);
				
				
				lstMap.add(map);
			}
			
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.addProperty("profitrate",m.get("profitrate").toString());
		obj.addProperty("successnums",m.get("successnums").toString());
		obj.add("rows", arr);
		
		return obj.toString();
		
	}
	
	public int countselfplan(String userid, String tag){
		StringBuffer count = new StringBuffer("select count(ep.id) from ExamplePlan ep where ep.fuserinfoid = ").append(Long.parseLong(userid)).append(" and ep.state = ").append(Integer.parseInt(tag));
		
		List lst = databaseHelper.getResultListByHql(count.toString());
		return Integer.parseInt(lst.get(0).toString());
	}
	
	
	public Map<String, Object> statisticselfplan(String userid, String tag){
		Map<String, Object> map = new HashMap<String, Object>();
		
		StringBuffer query = new StringBuffer("select ep from ExamplePlan ep where ep.fuserinfoid = ").append(Long.parseLong(userid)).append(" and ep.state = ").append(Integer.parseInt(tag));
		
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		
		Double total = 0d;
		int success = 0;
		for (Object object : lst) {
			ExamplePlan ep = (ExamplePlan)object;
			total += ep.getActualprofit();
			if(ep.getSuccessed()==1)success++;
		}
		
		double profitrate = new BigDecimal(total/lst.size()*100).setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue();  
		
		map.put("profitrate", profitrate);
		map.put("successnums", success);
		
		return map;
	}
	
	
	//查看所有计划列表
	private String queryallplanlst(String userid, String retype,String tag,  int start, int limit){
		
		int count = countallplan(userid, retype, tag);
		
		
		int pages = ConstantUtil.pages(count, limit);
		
		List<Map<String,Object>> lstMap = new ArrayList<Map<String,Object>>();
		
		if(count>0){
			StringBuffer query = new StringBuffer("select ep from ExamplePlan ep where 1 = 1");
			//-1所有  0沪深  1美股  2外汇
			if(retype!=null&&Integer.parseInt(retype)>-1)query.append(" and ep.type = ").append(Integer.parseInt(retype));
			
			//3精选计划  0抢购中  1运行中  2往期成功
			if(tag!=null){
				int int_tag = Integer.parseInt(tag);
				if(int_tag==3){//精选计划
					query.append(" and ep.ischoiceness = 1 ");
				}else{
					query.append(" and ep.ischoiceness = 0 ");
					if(int_tag==2){//往期成功
						query.append(" and ep.state = 2 and ep.successed = 1 ");
					}else{
						query.append(" and ep.state = ").append(int_tag);
					}
				}
			}
			
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(), start, limit);
			
			for (Object object : lst) {
				ExamplePlan ep = (ExamplePlan)object;
				
				
				
				Map<String, Object> map = new HashMap<String, Object>();
				map.put("planid",ep.getId());
				map.put("planname",ep.getPlanname());
				map.put("plandesc",ep.getPlandesc());
				map.put("targetprofit",ep.getTargetprofit());
				map.put("stopline",ep.getStopline());
				map.put("actualprofit",ep.getActualprofit());
				
				map.put("state", ep.getState());
				map.put("type", ConstantUtil.type[ep.getType()]);
				map.put("planstate", ConstantUtil.planstate[ep.getState()]);//0抢购 1运行中 2已结束
				
				//检查当前用户对计划是否抢购或观摩
				StringBuffer checkb = new StringBuffer("select panicbuying from PanicBuying panicbuying where panicbuying.fexampleplanid = ").append(ep.getId())
						.append(" and panicbuying.fuserinfoid = ").append(Long.parseLong(userid));
				List<Object> checked = databaseHelper.getResultListByHql(checkb.toString());
				if(checked.size()==0){
					map.put("panicbuying", -1);
				}else{
					PanicBuying panicbuying = (PanicBuying)checked.get(0);
					map.put("panicbuying", panicbuying.getState());
				}
				
				map = staticofplan(map, ep);
				
				Map<String, Object> m = statisticallplan(userid, ep.getFuserinfoid().toString());
				map.put("profitrate",m.get("profitrate").toString());
				map.put("successnums",m.get("successnums").toString());
				
				//牛人信息
				UserInfo example = (UserInfo)databaseHelper.getObjectById(UserInfo.class, ep.getFuserinfoid());
				map.put("name",example.getNickname()==null?example.getName():example.getNickname());
				map.put("headimg",example.getHeadimg());
				
				lstMap.add(map);
			}
			
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",count);
		obj.addProperty("pages",pages);
		obj.add("rows", arr);
		
		return obj.toString();
		
	}
	
	public int countallplan(String userid, String retype, String tag){
		StringBuffer count = new StringBuffer("select count(ep.id) from ExamplePlan ep where 1 = 1 ");
		
		//-1所有  0沪深  1美股  2外汇
		if(retype!=null&&Integer.parseInt(retype)>-1)count.append(" and ep.type = ").append(Integer.parseInt(retype));
		
		//3精选计划  0抢购中  1运行中  2往期成功
		if(tag!=null){
			int int_tag = Integer.parseInt(tag);
			if(int_tag==3){//精选计划
				count.append(" and ep.ischoiceness = 1 ");
			}else{
				count.append(" and ep.ischoiceness = 0 ");
				if(int_tag==2){//往期成功
					count.append(" and ep.state = 2 and ep.successed = 1 ");
				}else{
					count.append(" and ep.state = ").append(int_tag);
				}
			}
		}
		
		List lst = databaseHelper.getResultListByHql(count.toString());
		return Integer.parseInt(lst.get(0).toString());
	}
	
	
	public Map<String, Object> statisticallplan(String userid, String exampleid){
		Map<String, Object> map = new HashMap<String, Object>();
		
		StringBuffer query = new StringBuffer("select ep from ExamplePlan ep where ep.fuserinfoid = ").append(Long.parseLong(exampleid));
		
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		
		Double total = 0d;
		int success = 0;
		for (Object object : lst) {
			ExamplePlan ep = (ExamplePlan)object;
			total += ep.getActualprofit();
			if(ep.getSuccessed()==1)success++;
		}
		
		double profitrate = new BigDecimal(total/lst.size()*100).setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue();  
		
		map.put("profitrate", profitrate);
		map.put("successnums", success);
		
		return map;
	}

	@Override
	@Transactional(propagation=Propagation.REQUIRED,rollbackFor=Exception.class)
	public String follow(String userid, String exampleid) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("参数userid不能为空");
		if(exampleid==null||exampleid.length()==0)throw new Exception("参数exampleid不能为空");
		
		if(userid.equals(exampleid))throw new Exception("不要自己关注自己o(︶︿︶)o");
		
		StringBuffer query = new StringBuffer("select follow from Follow follow where follow.ffollowedid = ").append(exampleid).append(" and follow.fuserinfoid = ").append(userid);
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		
		int followed = 0;
		if(lst.size() ==0){
			Follow follow = new Follow();
			follow.setCreatetime(new Date());
			follow.setFfollowedid(Long.parseLong(exampleid));
			follow.setFuserinfoid(Long.parseLong(userid));
			follow.setState(0);
			databaseHelper.persistObject(follow);
			followed = 1;
		}else{
			Follow follow = (Follow)lst.get(0);
			int state = follow.getState()==1?0:1;
			follow.setState(state);
			
			databaseHelper.updateObject(follow);
			followed = state;
		}
		
		Map<String,Object> map = new HashMap<String,Object>();
		
		map.put("msg", "success");
		map.put("info", "操作成功");
		map.put("followed", followed);
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
	}

	@Override
	@Transactional(propagation=Propagation.REQUIRED,rollbackFor=Exception.class)
	public String subscription(String userid, String exampleid, String month, String amount) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("参数userid不能为空");
		if(exampleid==null||exampleid.length()==0)throw new Exception("参数exampleid不能为空");
		
		if(userid.equals(exampleid))throw new Exception("不能自己订阅自己o(︶︿︶)o");
		
		UserInfo u = (UserInfo)databaseHelper.getObjectById(UserInfo.class,Long.parseLong(userid));
		
		StringBuffer query = new StringBuffer("select s from Subscription s where s.fsubscribedid = ").append(exampleid).append(" and s.fuserinfoid = ").append(userid);
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		
		int subscribed = 0;
		if(lst.size() ==0){
			//检查是否有足够的金币
			if(amount==null||amount.length()==0)throw new Exception("参数amount不能为空");
			if(month==null||month.length()==0)throw new Exception("参数month不能为空");
			if(u.getGolds()<Double.parseDouble(amount))throw new Exception("很抱歉，你的金币不足，无法订阅o(︶︿︶)o");
			
			Subscription s = new Subscription();
			s.setCreatetime(new Date());
			s.setFsubscribedid(Long.parseLong(exampleid));
			s.setFuserinfoid(Long.parseLong(userid));
			s.setState(0);
			s.setAmount(Double.parseDouble(amount));
			s.setStarttime(s.getCreatetime());
			
			Calendar cl = Calendar.getInstance();  
	        cl.setTime(s.getCreatetime());  
	        cl.add(Calendar.MONTH, Integer.parseInt(month));  
			
			s.setEndtime(cl.getTime());
			databaseHelper.persistObject(s);
			subscribed = 1;
		}else{
			Subscription s = (Subscription)lst.get(0);
			int state = s.getState()==1?0:1;
			
			if(state==1){
				//检查是否有足够的金币
				if(amount==null||amount.length()==0)throw new Exception("参数amount不能为空");
				if(month==null||month.length()==0)throw new Exception("参数month不能为空");
				if(u.getGolds()<Double.parseDouble(amount))throw new Exception("很抱歉，你的金币不足，无法订阅o(︶︿︶)o");
			}
			
			s.setState(state);
			
			s.setStarttime(new Date());
			
			Calendar cl = Calendar.getInstance();  
	        cl.setTime(s.getStarttime());  
	        cl.add(Calendar.MONTH, Integer.parseInt(month));  
			
			s.setEndtime(cl.getTime());
			
			databaseHelper.updateObject(s);
			subscribed = state;
		}
		
		Map<String,Object> map = new HashMap<String,Object>();
		
		map.put("msg", "success");
		map.put("info", "操作成功");
		map.put("subscribed", subscribed);
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
		
	}

	@Override
	@Transactional(propagation=Propagation.REQUIRED,rollbackFor=Exception.class)
	public String documentary(String userid, String exampleid, String amount) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("参数userid不能为空");
		if(exampleid==null||exampleid.length()==0)throw new Exception("参数exampleid不能为空");
		//if(amount==null||amount.length()==0)throw new Exception("参数amount不能为空");
		if(userid.equals(exampleid))throw new Exception("不能自己跟随自己o(︶︿︶)o");
		
		//检查用户是否已跟随此牛人
		StringBuffer query = new StringBuffer("select d from Documentary d where d.fuserinfoid = ").append(userid).append(" and d.ffollowuserinfoid = ").append(exampleid);
		List<Object> querylst = databaseHelper.getResultListByHql(query.toString());
		
		if(querylst.size()>0&&((Documentary)querylst.get(0)).getState()==1)throw new Exception("你已跟随此人，请不要重复操作o(︶︿︶)o");
		
		SyncDemo_股票行情 sd = new SyncDemo_股票行情();
		
		Double ta = 0d;
		//找出用户的与此牛人的跟单股票，全部卖出
		ta = checkuserwarehouse(exampleid, userid, sd, ta);
		
		Double d_amount =amount==null?ta: Double.parseDouble(amount);
		
		//更新用户的虚拟资金
		UserInfo ui = (UserInfo)databaseHelper.getObjectById(UserInfo.class, Long.parseLong(userid));
		ui.setVirtualcapital(ui.getVirtualcapital()+ta);
		databaseHelper.updateObject(ui);
		
		//检查用户的虚拟资金是否足够
		if(ui.getVirtualcapital()<d_amount)throw new Exception("你的虚拟资金不足o(︶︿︶)o");
		
		
		//跟随牛人买入相同比例的股票和外汇
		Double diffamount = getexamplewarehouse(exampleid, userid, sd, d_amount);
		
		
		//添加到跟单表
		if(querylst.size()==0){
			Documentary d = new Documentary();
			d.setActualyamount(d_amount-diffamount);
			d.setCreatetime(new Date());
			d.setFfollowuserinfoid(Long.parseLong(exampleid));
			d.setFuserinfoid(Long.parseLong(userid));
			d.setDiffamount(diffamount);
			d.setMoney(Integer.parseInt(amount));
			d.setState(0);
			databaseHelper.persistObject(d);
		}else{
			Documentary d = (Documentary)querylst.get(0);
			d.setActualyamount(d_amount-diffamount);
			d.setDiffamount(diffamount);
			d.setMoney(Integer.parseInt(amount));
			d.setState(0);
			databaseHelper.updateObject(d);
		}
		
		//更新用户的虚拟资金
		ui = (UserInfo)databaseHelper.getObjectById(UserInfo.class, Long.parseLong(userid));
		ui.setVirtualcapital(ui.getVirtualcapital()-d_amount);
		databaseHelper.updateObject(ui);
		
		if(amount!=null){
			//添加到资金明细表
			CapitalDetail cd = new CapitalDetail();
			cd.setFuserinfoid(Long.parseLong(userid));
			cd.setType(-5);
			cd.setCapital(d_amount);
			cd.setCreatetime(new Date());
			cd.setState(0);
			databaseHelper.persistObject(cd);
		}
		
		Map<String,Object> map = new HashMap<String,Object>();
		
		map.put("msg", "success");
		map.put("info", "操作成功");
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
	}
	
	//找出用户的与此牛人的跟单股票和外汇
	private Double checkuserwarehouse(String exampleid,String userid,SyncDemo_股票行情 sd,Double ta) throws Exception{
		//找出用户的与此牛人的跟单股票，全部卖出
		StringBuffer finddocumentary = new StringBuffer("select swh from SharesWareHouse swh where swh.state = 1 and swh.fuserinfoid = ").append(userid)
				.append(" and swh.fexampleid =").append(exampleid).append(" and swh.couldusenums > 0");
		List<Object> doclst = databaseHelper.getResultListByHql(finddocumentary.toString());
		for (Object object : doclst) {
			SharesWareHouse swh = (SharesWareHouse)object;
			
			Double nowPrice = getpriceofshares(swh, sd);
			//将此股票的持仓平掉
			swh.setCouldusenums(0);
			databaseHelper.updateObject(swh);
			
			//新增一条卖出记录
			SharesWareHouse newswh = swh;
			newswh.setId(null);
			newswh.setCouldusenums(swh.getWarehousenums());
			newswh.setWarehousenums(swh.getWarehousenums());
			newswh.setFshareswarehouseid(swh.getId());
			newswh.setMarketvalue(nowPrice*swh.getWarehousenums());
			newswh.setPrice(nowPrice);
			newswh.setProfitloss(newswh.getMarketvalue()-swh.getCost());
			newswh.setState(-1);
			newswh.setTime(new Date());
			databaseHelper.persistObject(newswh);
			
			//添加到资金明细表
			CapitalDetail cd = new CapitalDetail();
			cd.setFuserinfoid(Long.parseLong(userid));
			cd.setType(swh.getType()==0?1:3);
			cd.setCapital(newswh.getMarketvalue());
			cd.setCreatetime(new Date());
			cd.setState(0);
			databaseHelper.persistObject(cd);
			
			//累加市值
			ta+=newswh.getMarketvalue();
		}
		
		
		//找出用户的与此牛人的跟单外汇，全部卖出
		finddocumentary = new StringBuffer("select fe from ForeignExchange fe where fe.state = 1 and swh.fuserinfoid = ").append(userid)
				.append(" and swh.fexampleid =").append(exampleid).append(" and swh.couldusenums > 0");
		doclst = databaseHelper.getResultListByHql(finddocumentary.toString());
		for (Object object : doclst) {
			ForeignExchange fe = (ForeignExchange)object;
			
			Double nowPrice = getpriceofwh(fe);
			//将此外汇的持仓平掉
			fe.setCouldusenums(0);
			databaseHelper.updateObject(fe);
			
			//新增一条卖出记录
			ForeignExchange newfe = fe;
			newfe.setId(null);
			newfe.setCouldusenums(fe.getWarehousenums());
			newfe.setWarehousenums(fe.getWarehousenums());
			newfe.setFforeignexchangeid(fe.getId());
			//newfe.setMarketvalue(nowPrice*fe.getWarehousenums());
			newfe.setPrice(nowPrice);
			newfe.setProfitloss(nowPrice*fe.getWarehousenums()-fe.getPurchase());
			newfe.setSellout(nowPrice*fe.getWarehousenums());
			newfe.setState(-1);
			newfe.setTime(new Date());
			databaseHelper.persistObject(newfe);
			
			//添加到资金明细表
			CapitalDetail cd = new CapitalDetail();
			cd.setFuserinfoid(Long.parseLong(userid));
			cd.setType(2);
			cd.setCapital(newfe.getSellout());
			cd.setCreatetime(new Date());
			cd.setState(0);
			databaseHelper.persistObject(cd);
			
			//累加市值
			ta+=newfe.getSellout();
		}
				
		return ta;
	}
	
	
	private Double getexamplewarehouse(String exampleid,String userid,SyncDemo_股票行情 sd,Double d_amount) throws Exception{
		//找出牛人持仓的股票
		StringBuffer find = new StringBuffer("select swh from SharesWareHouse swh where swh.state = 0 and swh.fuserinfoid = ").append(Long.parseLong(exampleid));
		List<Object> lst = databaseHelper.getResultListByHql(find.toString());
		
		List<Map<String, Object>> lstMap = new ArrayList<Map<String,Object>>(); 
		Double totalshars = 0d;
		for (Object object : lst) {
			SharesWareHouse swh = (SharesWareHouse)object;
			
			Double nowPrice = getpriceofshares(swh, sd);
			
			Map<String, Object> map = new HashMap<String, Object>();
			map.put("code", swh.getCode());
			map.put("sharesname", swh.getSharesname());
			map.put("shareid", swh.getFsharesid());
			map.put("type", swh.getType());
			map.put("nowPrice", nowPrice);
			map.put("marketvalue", nowPrice*swh.getCouldusenums());
			
			totalshars += nowPrice*swh.getCouldusenums();
			
			swh.setPrice(nowPrice);
			swh.setMarketvalue(nowPrice*swh.getCouldusenums());
			databaseHelper.updateObject(swh);
			
			lstMap.add(map);
		}
		
		//找出牛人持仓的外汇
		find = new StringBuffer("select fe from ForeignExchange fe where fe.state = 0 and fe.fuserinfoid = ").append(Long.parseLong(exampleid));
		lst = databaseHelper.getResultListByHql(find.toString());
		
		Double totalwh = 0d;
		for (Object object : lst) {
			ForeignExchange fe = (ForeignExchange)object;
			
			Double nowPrice = getpriceofwh(fe);
			
			Map<String, Object> map = new HashMap<String, Object>();
			map.put("code", fe.getCode());
			map.put("sharesname", fe.getForeignexchangename());
			map.put("shareid", fe.getFsharesid());
			map.put("type", 2);
			map.put("nowPrice", nowPrice);
			map.put("marketvalue", nowPrice*fe.getCouldusenums());
			
			totalwh += nowPrice*fe.getCouldusenums();
			
			fe.setPrice(nowPrice);
			databaseHelper.updateObject(fe);
			
			lstMap.add(map);
		}


		Double total = totalshars+totalwh;//跟随的牛人所有持仓的总金额
		Double diffamount = 0d;//多余的金额
		for (Map<String, Object> map : lstMap) {
			Double marketvalue = Double.parseDouble(map.get("marketvalue").toString());
			Double nowPrice = Double.parseDouble(map.get("nowPrice").toString());//当前价
			Double cost = marketvalue/total*d_amount;//成本
			
			int usenums = (int)(cost/nowPrice);
			
			diffamount += ((cost/nowPrice) - (int)(cost/nowPrice))*nowPrice;
			
			int type = Integer.parseInt(map.get("type").toString());
			
			if(type<2){
				//添加到用户股票表
				SharesWareHouse swh = new SharesWareHouse();
				swh.setCode(map.get("code").toString());
				swh.setCost(cost);
				swh.setCouldusenums(usenums);
				swh.setFexampleid(Long.parseLong(exampleid));
				swh.setFsharesid(Long.parseLong(map.get("shareid").toString()));
				swh.setFshareswarehouseid(0l);
				swh.setFuserinfoid(Long.parseLong(userid));
				swh.setIsplan(0);
				swh.setMarketvalue(nowPrice*usenums);
				swh.setPrice(nowPrice);
				swh.setProfitloss(0d);
				swh.setSharesname(map.get("sharesname").toString());
				swh.setState(1);
				swh.setTime(new Date());
				swh.setType(Integer.parseInt(map.get("type").toString()));
				swh.setWarehousenums(usenums);
				databaseHelper.persistObject(swh);
				
				//添加到资金明细表
				CapitalDetail cd = new CapitalDetail();
				cd.setFuserinfoid(Long.parseLong(userid));
				cd.setType(swh.getType()==0?-1:-3);
				cd.setCapital(swh.getMarketvalue());
				cd.setCreatetime(new Date());
				cd.setState(0);
				databaseHelper.persistObject(cd);
				
			}else{
				//添加到外汇表
				ForeignExchange fe = new ForeignExchange();
				fe.setCode(map.get("code").toString());
				fe.setCouldusenums(usenums);
				fe.setFexampleid(Long.parseLong(exampleid));
				fe.setFsharesid(Long.parseLong(map.get("shareid").toString()));
				fe.setFforeignexchangeid(0l);
				fe.setFuserinfoid(Long.parseLong(userid));
				fe.setIsplan(0);
				fe.setForeignexchangename(map.get("sharesname").toString());
				fe.setPrice(nowPrice);
				fe.setProfitloss(0d);
				fe.setState(1);
				fe.setTime(new Date());
				fe.setSellout(0d);
				fe.setPurchase(0d);
				fe.setWarehousenums(usenums);
				fe.setFexampleplanid(0l);
				databaseHelper.persistObject(fe);
				
				//添加到资金明细表
				CapitalDetail cd = new CapitalDetail();
				cd.setFuserinfoid(Long.parseLong(userid));
				cd.setType(-2);
				cd.setCapital(fe.getSellout());
				cd.setCreatetime(new Date());
				cd.setState(0);
				databaseHelper.persistObject(cd);
			}
		}
		
		return diffamount;
	}
	
	//获取股票当前市价
	private Double getpriceofshares(SharesWareHouse swh,SyncDemo_股票行情 sd) throws Exception{
		Double nowPrice = 0d;
		if(swh.getType()==0){//沪深
			
			ApiResponse response = sd.股票行情(swh.getCode(), "0", "0");
			
			String result = new String(response.getBody(), "utf-8");
			
			JsonObject json = (JsonObject) new JsonParser().parse(result);
			
			if(json.get("showapi_res_code").getAsInt()==0){
			
				JsonObject jo = json.get("showapi_res_body").getAsJsonObject().get("stockMarket").getAsJsonObject();
			
				nowPrice = jo.get("nowPrice").getAsDouble();
			}
			
		}else{//美股
			
			String result = NowApiUtil.getShareIndexOfUS(swh.getCode());
			
			JsonObject json = (JsonObject) new JsonParser().parse(result);
			
			if(json.get("success").getAsInt()==1){
			
				JsonObject jo = json.get("result").getAsJsonObject().get("lists").getAsJsonObject().get(swh.getCode()).getAsJsonObject();
			
				nowPrice = jo.get("last_price").getAsDouble();
			}
		}
		
		return nowPrice;
	}
	
	//获取外汇当前汇率
	private Double getpriceofwh(ForeignExchange fe) throws Exception{
		Double nowPrice = 0d;
		
		String result = NowApiUtil.getWHIndex(fe.getCode());
		
		JsonObject json = (JsonObject) new JsonParser().parse(result);
		
		if(json.get("success").getAsInt()==1){
		
			JsonObject jo = json.get("result").getAsJsonObject();
		
			nowPrice = jo.get("rate").getAsDouble();
		}
		return nowPrice;
	}
	
	public static void main(String[] args) {
		Double d = 32103d;
		Double s = 32.19d;
		Sys.out(d/s);
		Sys.out((int)(d/s));
		Sys.out(d/s-(int)(d/s));
	}

	@Override
	public String plandetail(String userid, String exampleid, String planid) throws Exception {
		// TODO Auto-generated method stub
		ExamplePlan ep = (ExamplePlan)databaseHelper.getObjectById(ExamplePlan.class, Long.parseLong(planid));
		
		Map<String, Object> map = new HashMap<String, Object>();
		
		map.put("planid",ep.getId());
		map.put("planname",ep.getPlanname());
		map.put("plandesc",ep.getPlandesc());
		map.put("targetprofit",ep.getTargetprofit());
		map.put("stopline",ep.getStopline());
		map.put("actualprofit",ep.getActualprofit());
		
		
		map.put("state", ep.getState());
		map.put("type", ConstantUtil.type[ep.getType()]);
		map.put("planstate", ConstantUtil.planstate[ep.getState()]);//0抢购 1运行中 2已结束
		
		map = staticofplan(map, ep);
		
		Map<String, Object> m = statisticexampleplan(userid, exampleid);
		
		map.put("profitrate",m.get("profitrate").toString());
		map.put("successnums",m.get("successnums").toString());
		
		map.put("subscriptiongold",ConstantUtil.setting.getSubscriptiongold());//订阅牛人所需金币（单月）
		map.put("purchasegold",ConstantUtil.setting.getPurchasegold());//抢购计划所需金币
		map.put("viewgold",ConstantUtil.setting.getViewgold());//观摩计划所需金币
		
		StringBuffer query = new StringBuffer("select pb from PanicBuying pb where pb.fexampleplanid =").append(exampleid);
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		int purchase=0,view=0;
		for (Object object : lst) {
			PanicBuying pb = (PanicBuying)object;
			if(pb.getState()==0)purchase++;
			else view++;
		}
		
		map.put("purchase",purchase);//抢购计划人数
		map.put("getpurchasegolds",purchase*ConstantUtil.setting.getPurchasegold());//抢购计划所得金币
		
		//按计划抢购数量排序
		StringBuffer orderby = new StringBuffer("select fexampleplanid,count(fexampleplanid) as c from panicbuying where state = 0 Group by fexampleplanid order by c desc");
		List<Object[]> orderbylst = databaseHelper.getResultListBySql(orderby.toString());
		int i= 0;
		for (Object[] objects : orderbylst) {
			i++;
			if(ep.getId().equals(Long.parseLong(objects[0].toString())))break;
		}
		map.put("purchaseranking",i);
		
		map.put("view",view);//观摩计划人数
		map.put("getviewgolds",view*ConstantUtil.setting.getViewgold());//观摩计划所得金币
		
		//按计划数量排序
		orderby = new StringBuffer("select fexampleplanid,count(fexampleplanid) as c from panicbuying where state = 1 Group by fexampleplanid order by c desc");
		orderbylst = databaseHelper.getResultListBySql(orderby.toString());
		int j= 0;
		for (Object[] objects : orderbylst) {
			j++;
			if(ep.getId().equals(Long.parseLong(objects[0].toString())))break;
		}
		map.put("viewranking",j);
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
	}

	@Override
	public String planwarehouse(String userid, String exampleid, String planid,int rows) throws Exception {
		// TODO Auto-generated method stub
		ExamplePlan ep = (ExamplePlan)databaseHelper.getObjectById(ExamplePlan.class, Long.parseLong(planid));
		
		List<Map<String, Object>> lstMap = new ArrayList<Map<String,Object>>(); 
		
		if(ep.getType()<2){
			//股票
			StringBuffer get = new StringBuffer("select sum(swh.couldusenums) from SharesWareHouse swh where swh.isplan = 1 and swh.fexampleplanid = ")
					.append(ep.getId()).append(" and swh.state = 0 and swh.couldusenums > 0 ");
			List<Object> getlst = databaseHelper.getResultListByHql(get.toString());
			
			int totalwarehouse = getlst==null?0:getlst.size()==0?0:getlst.get(0)==null?0:Integer.parseInt(getlst.get(0).toString());
			
			StringBuffer query = new StringBuffer("select swh from SharesWareHouse swh where swh.isplan = 1 and swh.fexampleplanid = ")
					.append(ep.getId()).append(" and swh.state = 0 and swh.couldusenums > 0 ");
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(),1,rows);
			
			for (Object object : lst) {
				Map<String, Object> map = new HashMap<String, Object>();
				
				SharesWareHouse swh = (SharesWareHouse)object;
				
				map.put("sharename", swh.getSharesname());
				map.put("code", swh.getCode());
				map.put("market", swh.getMarket());
				map.put("cost", swh.getCost());
				
				map.put("warehouse", ConstantUtil.intdevice2(swh.getCouldusenums(), totalwarehouse, true)+"%");
				
				map.put("profitloss", swh.getProfitloss());
				map.put("profitlossrate", ConstantUtil.formatDouble(swh.getProfitloss()/swh.getCost())+"%");
				
				map.put("type", swh.getType()==0?"沪深":"美股");
				
				lstMap.add(map);
			}
			
		}else{
			//外汇
			StringBuffer get = new StringBuffer("select sum(fe.couldusenums) from ForeignExchange fe where fe.isplan = 1 and fe.fexampleplanid = ")
					.append(ep.getId()).append(" and fe.state = 0 and fe.couldusenums > 0 ");
			List<Object> getlst = databaseHelper.getResultListByHql(get.toString());
			
			int totalwarehouse = getlst==null?0:getlst.size()==0?0:getlst.get(0)==null?0:Integer.parseInt(getlst.get(0).toString());
			
			StringBuffer query = new StringBuffer("select fe from ForeignExchange fe where fe.isplan = 1 and fe.fexampleplanid = ")
					.append(ep.getId()).append(" and fe.state = 0 and fe.couldusenums > 0 ");
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(),1,rows);
			
			for (Object object : lst) {
				Map<String, Object> map = new HashMap<String, Object>();
				
				ForeignExchange fe = (ForeignExchange)object;
				
				map.put("sharename", fe.getForeignexchangename());
				map.put("code", fe.getCode());
				map.put("market", "");
				map.put("cost", fe.getPurchase());
				
				map.put("warehouse", ConstantUtil.intdevice2(fe.getCouldusenums(), totalwarehouse, true)+"%");
				
				map.put("profitloss", fe.getProfitloss());
				map.put("profitlossrate", ConstantUtil.formatDouble(fe.getProfitloss()/fe.getPurchase())+"%");
				
				map.put("type", "外汇");
				
				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",arr.size());
		obj.add("rows", arr);
		
		return obj.toString();
	}

	@Override
	public String planofnew(String userid, String exampleid, String planid,int tag,int rows) throws Exception {
		// TODO Auto-generated method stub
		ExamplePlan ep = (ExamplePlan)databaseHelper.getObjectById(ExamplePlan.class, Long.parseLong(planid));
		
		List<Map<String, Object>> lstMap = new ArrayList<Map<String,Object>>(); 
		
		if(ep.getType()<2){
			//股票
			StringBuffer get = new StringBuffer("select sum(swh.couldusenums) from SharesWareHouse swh where swh.isplan = 1 and swh.fexampleplanid = ")
					.append(ep.getId()).append(" and swh.state = ").append(tag).append(" and swh.couldusenums > 0 ");
			List<Object> getlst = databaseHelper.getResultListByHql(get.toString());
			
			int totalwarehouse = getlst==null?0:getlst.size()==0?0:getlst.get(0)==null?0:Integer.parseInt(getlst.get(0).toString());
			
			StringBuffer query = new StringBuffer("select swh from SharesWareHouse swh where swh.isplan = 1 and swh.fexampleplanid = ")
					.append(ep.getId()).append(" and swh.state = ").append(tag).append(" and swh.couldusenums > 0 order by swh.time desc");
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(),1,rows);
			
			for (Object object : lst) {
				Map<String, Object> map = new HashMap<String, Object>();
				
				SharesWareHouse swh = (SharesWareHouse)object;
				
				map.put("sharename", swh.getSharesname());
				map.put("code", swh.getCode());
				map.put("market", swh.getMarket());
				map.put("price", swh.getPrice());
				
				map.put("warehouse", ConstantUtil.intdevice2(swh.getCouldusenums(), totalwarehouse, true)+"%");
				
				map.put("usenums", swh.getWarehousenums());
				map.put("time", swh.getTime().toString());
				
				map.put("type", swh.getType()==0?"沪深":"美股");
				
				lstMap.add(map);
			}
			
		}else{
			//外汇
			StringBuffer get = new StringBuffer("select sum(fe.couldusenums) from ForeignExchange fe where fe.isplan = 1 and fe.fexampleplanid = ")
					.append(ep.getId()).append(" and fe.state = ").append(tag).append(" and fe.couldusenums > 0 ");
			List<Object> getlst = databaseHelper.getResultListByHql(get.toString());
			
			int totalwarehouse = getlst==null?0:getlst.size()==0?0:getlst.get(0)==null?0:Integer.parseInt(getlst.get(0).toString());
			
			StringBuffer query = new StringBuffer("select fe from ForeignExchange fe where fe.isplan = 1 and fe.fexampleplanid = ")
					.append(ep.getId()).append(" and fe.state = ").append(tag).append(" and fe.couldusenums > 0 order by fe.time desc ");
			List<Object> lst = databaseHelper.getResultListByHql(query.toString(),1,rows);
			
			for (Object object : lst) {
				Map<String, Object> map = new HashMap<String, Object>();
				
				ForeignExchange fe = (ForeignExchange)object;
				
				map.put("sharename", fe.getForeignexchangename());
				map.put("code", fe.getCode());
				map.put("market", "");
				map.put("price", fe.getPrice());
				
				map.put("warehouse", ConstantUtil.intdevice2(fe.getCouldusenums(), totalwarehouse, true)+"%");
				
				map.put("usenums", fe.getWarehousenums());
				map.put("time", fe.getTime().toString());
				
				map.put("type", "外汇");
				
				lstMap.add(map);
			}
		}
		
		String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.addProperty("total",arr.size());
		obj.add("rows", arr);
		
		return obj.toString();
	}

	@Override
	public String watchplan(String userid, String exampleid, String planid, String amount) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("参数userid不能为空");
		if(planid==null||planid.length()==0)throw new Exception("参数planid不能为空");
		if(amount==null||amount.length()==0)throw new Exception("参数amount不能为空");
		
		Date now = new Date();
		
		UserInfo ui = (UserInfo)databaseHelper.getObjectById(UserInfo.class, Long.parseLong(userid));
		
		ExamplePlan ep = (ExamplePlan)databaseHelper.getObjectById(ExamplePlan.class, Long.parseLong(planid));
		
		//检查计划是否开始运行
		if(ep.getState()==0)throw new Exception("计划还没开始运行，不能观摩");
		
		//检查用户是否观摩过此计划
		StringBuffer check = new StringBuffer("select pb from PanicBuying pb where pb.fuserinfoid = ").append(userid).append(" and pb.fexampleplanid =").append(exampleid);
		List<Object> lst = databaseHelper.getResultListByHql(check.toString());
		
		if(lst.size()>0){
			 PanicBuying pb =  (PanicBuying)lst.get(0);
			 if(pb.getState()==0)throw new Exception("你已抢购了此计划，不需要再观摩");
			 else throw new Exception("你已抢观摩了此计划，不要重复观摩");
		}
		
		//检查用户金币是否足够
		if(ui.getGolds()<ConstantUtil.setting.getViewgold())throw new Exception("你的金币不足，请先充值");
		
		//添加到金币明细表
		GoldsDetail gd = new GoldsDetail();
		gd.setCreatetime(now);
		gd.setFuserinfoid(ui.getId());
		gd.setGolds(Double.parseDouble(amount));
		gd.setState(0);
		gd.setType(-4);
		databaseHelper.persistObject(gd);
		
		//添加到抢购表
		PanicBuying pb = new PanicBuying();
		pb.setAmount(Double.parseDouble(amount));
		pb.setCreatetime(new Date());
		pb.setFexampleplanid(ep.getId());
		pb.setFgoldsdetailid(gd.getId());
		pb.setFuserinfoid(ui.getId());
		pb.setState(1);
		databaseHelper.persistObject(pb);
		
		//扣除用户金币
		ui.setGolds(ui.getGolds()-Double.parseDouble(amount));
		databaseHelper.updateObject(ui);
		
		Map<String,Object> map = new HashMap<String,Object>();
		
		map.put("msg", "success");
		map.put("info", "观摩成功");
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
	}

	@Override
	public String panicbuying(String userid, String exampleid, String planid, String amount) throws Exception {
		// TODO Auto-generated method stub
		if(userid==null||userid.length()==0)throw new Exception("参数userid不能为空");
		if(planid==null||planid.length()==0)throw new Exception("参数planid不能为空");
		if(amount==null||amount.length()==0)throw new Exception("参数amount不能为空");
		
		Date now = new Date();
		
		UserInfo ui = (UserInfo)databaseHelper.getObjectById(UserInfo.class, Long.parseLong(userid));
		
		ExamplePlan ep = (ExamplePlan)databaseHelper.getObjectById(ExamplePlan.class, Long.parseLong(planid));
		
		//检查计划是否开始运行
		if(ep.getState()>0)throw new Exception("计划已运行，不能抢购");
		
		//检查用户是否抢购过此计划
		StringBuffer check = new StringBuffer("select pb from PanicBuying pb where pb.fuserinfoid = ").append(userid).append(" and pb.fexampleplanid =").append(exampleid);
		List<Object> lst = databaseHelper.getResultListByHql(check.toString());
		
		if(lst.size()>0){
			 PanicBuying pb =  (PanicBuying)lst.get(0);
			 if(pb.getState()==0)throw new Exception("你已抢购了此计划，不要重复抢购");
		}
		
		//检查用户金币是否足够
		if(ui.getGolds()<ConstantUtil.setting.getPurchasegold())throw new Exception("你的金币不足，请先充值");
		
		//添加到金币明细表
		GoldsDetail gd = new GoldsDetail();
		gd.setCreatetime(now);
		gd.setFuserinfoid(ui.getId());
		gd.setGolds(Double.parseDouble(amount));
		gd.setState(0);
		gd.setType(-3);
		databaseHelper.persistObject(gd);
		
		//添加到抢购表
		PanicBuying pb = new PanicBuying();
		pb.setAmount(Double.parseDouble(amount));
		pb.setCreatetime(new Date());
		pb.setFexampleplanid(ep.getId());
		pb.setFgoldsdetailid(gd.getId());
		pb.setFuserinfoid(ui.getId());
		pb.setState(0);
		databaseHelper.persistObject(pb);
		
		//扣除用户金币
		ui.setGolds(ui.getGolds()-Double.parseDouble(amount));
		databaseHelper.updateObject(ui);
		
		Map<String,Object> map = new HashMap<String,Object>();
		
		map.put("msg", "success");
		map.put("info", "抢购成功");
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
	}

	@Override
	public String publishplan(ExamplePlan ep) throws Exception {
		// TODO Auto-generated method stub
		if(ep.getFuserinfoid()==null)throw new Exception("参数userid不能为空");
		
		UserInfo ui = (UserInfo)databaseHelper.getObjectById(UserInfo.class, ep.getFuserinfoid());
		
		if(ui.getIsexample()==0)throw new Exception("你不是牛人，不能发布计划");
		
		//检查用户是否有计划
		StringBuffer check = new StringBuffer("select ep from ExamplePlan ep where ep.state < 2 and ep.fuserinfoid = ").append(ui.getIntro()).append(" order by ep.endtime");
		List<Object> lst = databaseHelper.getResultListByHql(check.toString());
		
		if(lst.size()>0){
			ExamplePlan eplan = (ExamplePlan)lst.get(0);
			
			//检查计划开始时间是否在往期最新计划结束时间的三天后
			
			if(ConstantUtil.differentDays(eplan.getEndtime(), ep.getStarttime())<=3)throw new Exception("计划开始时间必须在你最新计划结束时间的三天后");
			
		}
		
		ep.setActualprofit(0d);
		ep.setCreatetime(new Date());
		ep.setIschoiceness(0);
		ep.setState(0);
		ep.setSuccessed(0);
		
		databaseHelper.persistObject(ep);
		
		Map<String,Object> map = new HashMap<String,Object>();
		
		map.put("msg", "success");
		map.put("info", "计划发布成功");
		
		String json = JsonUtil.getGson().toJson(map);
		return json;
	}

	@Override
	public String profitstatistic(String userid, String exampleid, int tag) throws Exception {
		// TODO Auto-generated method stub
		
    	StringBuffer find = new StringBuffer("select upt from UserProfit upt where upt.fuserinfoid = ").append(userid).append(" order by upt.time desc");
    	List<Object> lst = databaseHelper.getResultListByHql(find.toString());
		
		Date now = new Date();
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
		
		userid = exampleid==null?userid:exampleid;
		
		List<Map<String, Object>> lstMap = new ArrayList<Map<String,Object>>(); 
		
        StringBuffer query = null;
        if(tag==1){
        	for (int i = 0; i <= 30; i++) {
        		if(i==0||i==30||i%8==0){
        			
        			Map<String,Object> map = timeindexofday(query, userid, now, i, sdf);
        	        
        	        lstMap.add(map);
        		}
			}
        }else if(tag==2){
        	for (int i = 0; i <= 5; i++) {
        		if(i==0||i==5||i%2==0){
        			
        			Map<String,Object> map = timeindexofmonth(query, userid, now, i, sdf);
        	        
        	        lstMap.add(map);
        		}
			}
        }else if(tag==3){
        	for (int i = 0; i <= 11; i++) {
        		if(i==0||i==11||i%4==0){
        			
        			Map<String,Object> map = timeindexofmonth(query, userid, now, i, sdf);
        	        
        	        lstMap.add(map);
        		}
			}
        }else{
        	
        	
        	if(lst.size()>0){
        		
        		UserProfit lastupt = (UserProfit)lst.get(0);
        		UserProfit firstupt = (UserProfit)lst.get(lst.size()-1);
        		
        		//检查两条数据的时间差
        		int diff = ConstantUtil.differentDays(firstupt.getTime(), lastupt.getTime());
        		if(diff<=3){
        			for (int i = 0; i <= 3; i++) {
        				Map<String,Object> map = timeindexofday(query, userid, now, i, sdf);
            	        
            	        lstMap.add(map);
					}
        			
        		}else if(diff<=180){
        			
        		}
        	}
        }
        
        String json = new Gson().toJson(lstMap);
		JsonArray arr = (JsonArray) new JsonParser().parse(json);
		JsonObject obj = new JsonObject();
		obj.add("rows", arr);
		obj.addProperty("userprofit", lst.size()==0?"0%":((UserProfit)lst.get(0)).getProfitrate().toString());//用户收益
		obj.addProperty("stockindexprofit", lst.size()==0?"0%":((UserProfit)lst.get(0)).getProfitrate().toString());//大盘收益  
		return obj.toString();
	}
	
	private Map<String, Object> timeindexofday(StringBuffer query,String userid,Date now,int i,SimpleDateFormat sdf){
		Map<String,Object> map = new HashMap<String,Object>();
		
		query = new StringBuffer("select sum(upt.diffprofitoflasttime) 'a' from userprofit upt where upt.fuserinfoid = ").append(userid)
			.append(" and TO_DAYS(NOW()) - TO_DAYS(upt.time) = ").append(i); 
		
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		
		Double profit = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		
		Calendar c = Calendar.getInstance();
        c.setTime(now);
        c.add(Calendar.DAY_OF_MONTH, -i);
        
        Date time = c.getTime();
        
        map.put("profit", profit);
        map.put("stockindex", i+"%");
        map.put("time", sdf.format(time));
        return map;
	}
	
	private Map<String, Object> timeindexofmonth(StringBuffer query,String userid,Date now,int i,SimpleDateFormat sdf){
		Map<String,Object> map = new HashMap<String,Object>();
		
		query = new StringBuffer("select sum(upt.diffprofitoflasttime) 'a' from userprofit upt where upt.fuserinfoid = ").append(userid)
			.append(" and PERIOD_DIFF( date_format( now() , '%Y%m' ) , date_format(upt.time, '%Y%m' ) ) = ").append(i); 
		
		List<Object> lst = databaseHelper.getResultListByHql(query.toString());
		
		Double profit = lst==null?0d:lst.size()==0?0d:lst.get(0)==null?0d:Double.parseDouble(lst.get(0).toString());
		
		Calendar c = Calendar.getInstance();
        c.setTime(now);
        c.add(Calendar.MONTH, -i);
        
        Date time = c.getTime();
        
        map.put("profit", profit);
        map.put("stockindex", i+"%");
        map.put("time", sdf.format(time));
        
        return map;
	}

	@Override
	public String tradestatistic(String userid, String exampleid, int tag, int type) throws Exception {
		// TODO Auto-generated method stub
		userid = exampleid==null?userid:exampleid;
		
		UserInfo u = (UserInfo)databaseHelper.getObjectById(UserInfo.class, Long.parseLong(userid));
		
		
		
		return null;
	}
}
